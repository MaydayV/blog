name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v44
      with:
        files: |
          source/_posts/**/*.md

    - name: Check markdown files
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "Changed markdown files:"
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          echo "- $file"
          
          # æ£€æŸ¥ front-matter
          if ! grep -q "^---" "$file"; then
            echo "âŒ Error: $file ç¼ºå°‘ front-matter"
            exit 1
          fi
          
          # æ£€æŸ¥å¿…éœ€çš„ front-matter å­—æ®µ
          if ! grep -q "^title:" "$file"; then
            echo "âŒ Error: $file ç¼ºå°‘ title å­—æ®µ"
            exit 1
          fi
          
          if ! grep -q "^date:" "$file"; then
            echo "âŒ Error: $file ç¼ºå°‘ date å­—æ®µ"
            exit 1
          fi
          
          if ! grep -q "^author:" "$file"; then
            echo "âš ï¸ Warning: $file ç¼ºå°‘ author å­—æ®µ"
          fi
          
          echo "âœ… $file æ£€æŸ¥é€šè¿‡"
        done

    - name: Check filename format
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          filename=$(basename "$file")
          # æ£€æŸ¥æ–‡ä»¶åæ ¼å¼: YYYY-MM-DD-*.md
          if ! echo "$filename" | grep -qE '^[0-9]{4}-[0-9]{2}-[0-9]{2}-'; then
            echo "âŒ Error: æ–‡ä»¶åæ ¼å¼é”™è¯¯: $filename"
            echo "   æ­£ç¡®æ ¼å¼: YYYY-MM-DD-article-title.md"
            exit 1
          fi
        done
        echo "âœ… æ‰€æœ‰æ–‡ä»¶åæ ¼å¼æ­£ç¡®"

  build:
    runs-on: ubuntu-latest
    needs: lint
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install dependencies
      run: npm ci

    - name: Build site
      run: npm run build

    - name: Check build output
      run: |
        if [ ! -d "public" ]; then
          echo "âŒ Error: æ„å»ºè¾“å‡ºç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        if [ ! -f "public/index.html" ]; then
          echo "âŒ Error: é¦–é¡µæ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "âœ… æ„å»ºæˆåŠŸ"
        echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
        echo "   - HTML æ–‡ä»¶: $(find public -name '*.html' | wc -l)"
        echo "   - CSS æ–‡ä»¶: $(find public -name '*.css' | wc -l)"
        echo "   - JS æ–‡ä»¶: $(find public -name '*.js' | wc -l)"
